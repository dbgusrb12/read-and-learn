# 프로토콜 스택에 메시지 송신을 의뢰한다.

## 데이터 송/수신 동작의 개요

IP 주소를 조사 한 후, IP 주소의 상대(액세스 대상이 되는 웹 서버)에 메시지를 송신하도록 OS 내부의 프로토콜 스택에 의뢰한다.

이 메시지(디지털 데이터)를 송/수신 하는 동작은 네트워크를 이용하는 애플리케이션 전체에 공통이다.

DNS 서버에 IP 주소를 조회 할 때와 같이 Socket 라이브러리에 들어있는 프로그램 부품을 이용하지만, 여러개의 부품을 이용하기 때문에 복잡하다.

### 프로토콜 스택에서 실행하는 데이터 송/수신 흐름

1. 소켓을 생성한다. (소켓 작성 단계)
2. 서버측의 소켓에 파이프를 연결한다. (접속 단계)
3. 데이터를 송/수신 한다. (송/수신 단계)
4. 파이프를 분리하고 소켓을 말소한다. (연결 끊기 단계)

## 소켓의 작성 단계

Socket 라이브러리의 리졸버(gethostbyname)를 사용해 DNS 서버에 접속하여 IP 주소를 조회 해 온 뒤,   
소켓을 만드는 단계로 들어가는데,   
클라이언트측 소켓을 만드는건 `socket(<IPv4 사용>, <스트림형>, ...)`을 호출해서 만든다.   
`socket` 을 호출하면, 리졸버를 호출했을 때와 같이 socket 내부에 제어가 넘어가 소켓을 만드는 동작을 실행하고,   
디스크립터라는 것이 돌아온다. 애플리케이션은 이 디스크립터를 메모리에 기록해 둔다.

컴퓨터 내부에는 복수의 데이터 송/수신 동작이 동시에 진행되는 경우가 있기 때문에 해당 소켓을 식별 할 수 있는 것이 필요한데,   
이걸 디스크립터라고 한다.

## 파이프를 연결하는 접속 단계

소켓을 만들고 디스크립터를 받고 나면, 해당 소켓을 서버측의 소켓에 접속하도록 프로토콜 스택에 의뢰한다.  
이 때 사용하는게 `connect(<디스크립터>, <서버의 IP 주소와 포트 번호>, ...)` 이다.

socket 메서드를 사용하여 디스크립터를 받고, IP 주소는 DNS 로 조회 해서 받지만,  
포트 번호는 애플리케이션에 종류에 따라 나뉘기 때문에, 미리 정해진 값을 사용한다는 규칙이 있다.

클라이언트측의 소켓의 포트 번호는 소켓이 생성 될 때 프로토콜 스택이 적당한 값을 골라서 할당하고,  
해당하는 값을 접속 동작 실행 할 때 서버측에 통지한다.

정리하자면,  
connect 를 호출하면서 프로토콜 스택이 접속 동작을 실행하고,  
상대와 연결되면 프로토콜 스택은 연결된 상대의 IP 주소나 포트 번호 등의 정보를 소켓에 기록한 뒤,  
비로소 데이터 송/수신이 가능한 상태가 된다.

## 메시지를 주고 받는 송/수신 단계

소켓이 연결 된 후에는 `write(<디스크립터>, <송신 데이터>, <송신 데이터 길이>)` 를 사용하여 상대측 소켓에 데이터를 전달하고,  
서버에서 반송되는 메시지는 `read(<디스크립터>, <수신 버퍼>, ...)` 를 사용하여 읽고, 수신 버퍼에 저장한다.  
애플리케이션은 수신한 응답 메시지를 저장하기 위한 메모리 영역을 지정하는데, 이 메모리 영역을 수신 버퍼라고 부른다.

## 연결 끊기 단계에서 송/수신이 종료된다.

브라우저가 데이터 수신을 완료 하게 되는 시점이 송/수신 동작이 끝나는 시점이다.   
그 이후에는 `close(<디스크립터>)` 를 사용하여 연결 끊기 단계로 들어가도록 의뢰한다.

HTTP 프로토콜에서는 응답 메시지의 송신을 완료했을 때 웹 서버측에서 연결 끊기 동작을 행하기 때문에,  
웹 서버측에서 먼저 `close`를 호출하여 연결을 끊고, 해당 행동이 클라이언트측에 전달되어 클라이언트의 소켓이 연결 끊기 단계로 들어간다.

그리고 브라우저가 `read`로 수신 동작을 의뢰했을 때 `read`는 수신한 데이터를 건네주는 대신   
송/수신 동작이 완료 되었다고 브라우저에 통지한다.

마지막으로 브라우저에서는 그 시점에 `close`를 호출하여 연결 끊기 단계에 들어간다.

