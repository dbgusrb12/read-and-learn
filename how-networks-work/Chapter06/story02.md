# 서버의 수신 동작

## LAN 어댑터에서 수신 신호를 디지털 데이터로 변환한다.

수신 동작은 패킷의 신호를 LAN 어댑터에서 수신하고 디지털 데이터로 바꾸는 부분에서 시작된다.  
LAN 에 흐르는 패킷의 신호는 1과 0으로 이루어진 디지털 데이터의 신호와 타이밍을 나타내는 클록 신호를 합성한 것이다.  
여기서 클록 신호를 추출하고 클록 신호에서 타이밍을 계산하면서 신호를 읽어오면, 1과 0의 디지털 데이터로 바꿀 수 있다.

10BASE-T 를 기준으로 설명한다면, 먼저 프리앰블 부분에서 클록을 추출한다. 프리앰블 부분은 신호가 일정 간격으로 규칙적으로 변화하므로  
변화의 타이밍을 조사하면 클록이 어느 위치에 있는지 알 수 있다. 그러면 클록을 같은 간격으로 연장하고, 클록의 위치에서 신호의 변화의 방향을  
조사한 뒤 신호의 변화를 디지털 데이터에 대응시켜 디지털 데이터로 변환시킨다.  
그 다음 패킷의 맨 마지막에 있는 프레임 체크 시퀀스 (FCS) 라는 오류 검사용 데이터를 이용하여 오류 유무를 검사한다.  
FCS 가 일치하고 오류가 없는 것을 확인한 다음에는 맨 앞의 MAC 헤더에 있는 수신처 MAC 주소를 조사하여 패킷이 자신을 수신처로 하여 보낸 것인지  
판단한 뒤 자신이 수신처가 아닌 패킷은 모두 버린다.  
디지털 데이터로 되돌린 것을 LAN 어댑터 내부의 버퍼 메모리에 저장한다.

LAN 드라이버가 MAC 헤더로부터 프로토콜을 판단하여 프로토콜 스택에 패킷을 건네준다.

## IP 담당 부분의 수신 동작

프로토콜 스택에 패킷이 전달되면 우선 IP 담당 부분이 동작하여 IP 헤더를 점검한 뒤 해당 내용이 규칙에 따라 올바르게 만들어졌는지부터  
점검한 후 수신처 IP 주소가 자신을 대상으로 하는지 조사한다. 서버에서 라우터와 같이 패킷을 중계하는 기능이 유효하게 된 경우에는 자신을  
대상으로 하지 않은 패킷이 도착할 수 있다. 그럴 경우 라우터와 같이 경로표에서 중계 대상을 조사하고 그것에 패킷을 중계한다.  
패킷이 자신을 대상으로 온 것이면 패킷의 분할 여부를 조사한 뒤 분할된 패킷일 경우 메모리에 저장해두고 조각이 전부 도착한 시점에 원래 패킷으로  
복원을 한다.  
그리고 IP 헤더의 프로토콜 번호 항목을 조사하여 해당하는 담당 부분에 패킷을 건네준다.

## TCP 담당 부분이 접속 패킷을 수신했을 때의 동작

패킷의 TCP 헤더에 있는 SYN 이라는 컨트롤 비트가 1로 되어있으면 접속 동작의 패킷이다. 이 경우 접속을 접수하는 동작을 실행하는데,  
그 전에 도착한 패킷의 수신처 포트 번호를 조사하여 이 번호와 같은 번호를 할당한 접속 대기 상태의 소켓이 있는지 확인한다.  
만약 수신처 포트 번호와 같은 포트 번호의 접속 대기 소켓이 없으면 잘못된 것이므로 오류 통지 패킷을 클라이언트에 반송한다.

해당하는 접속 대기 소켓이 있으면 패킷을 복사하여 새 소켓을 만들고, 여기에 송신처 IP 주소, 포트 번호, 시퀀스 번호 초기값, 윈도우 값 등  
필요한 정보를 기록한다. 동시에 송신 버퍼나 수신 버퍼로 사용되는 메모리 영역을 확보하고, 패킷을 받았음을 나타내는 ACK 번호, 서버에서  
클라이언트에 보내는 데이터에 관한 시퀀스 번호의 초기값, 클라이언트에서 서버로 보내온 데이터를 받기 위한 수신 버퍼의 빈 용량을 나타내는 윈도우  
값 등의 항목을 기록한 TCP 헤더를 만들고, 이것을 IP 담당 부분에 의뢰하여 클라이언트에 반송한다.

이 패킷이 클라이언트에 도착하면 클라이언트에서 패킷을 받았음을 나타내는 ACK 번호가 돌아오면 접속 동작이 완료된다.  
이 때 서버측 애플리케이션은 accept 를 호출하여 실행을 쉬는 상태 이고, 여기에 새로 만든 소켓의 디스크립터를 전달하여 서버 애플리케이션의  
동작을 재개한다.

## TCP 담당 부분이 데이터 패킷을 수신했을 때의 동작

TCP 담당 부분은 도착한 패킷이 어느 소켓에 해당하는지 조사한다.  
접속이 끝난 소켓의 경우 서버측의 포트 번호로서 같은 값을 할당한 여러 개의 소켓이 존재할지도 모르므로 수신처 포트 번호만으로는 소켓을 지정할 수 없다.  
그래서 IP 헤더의 송신처 IP 주소와 수신처 IP 주소, TCP 헤더의 수신처 포트 번호와 송신처 포트 번호 라는 4개의 정보가 모두 일치하는 소켓을 찾는다.

해당 소켓을 반견하면 패킷에 기록되어 있는 데이터 송/수신의 진행 상황과 도착한 패킷의 TCP 헤더의 정보를 결합하여 데이터 송/수신 동작이 올바르게 진행되고  
있는지 점검한다. 이 과정을 통해 수신한 데이터를 수신 버퍼에 저장하면 수신 확인 응답용 TCP 헤더를 만든다.  
여기에 수신 패킷의 시퀀스 번호와 데이터 조각의 길이로부터 계산한 ACK 번호를 기록하고 IP 담당 부분에 의뢰해 클라이언트에 반송한다.

## TCP 담당 부분의 연결 끊기 동작

데이터 송/수신이 끝나면 연결 끊기 동작에 들어간다. 이때의 동작은 클라이언트측과 같다.

웹의 경우 HTTP 1.0 이라면 서버에서 연결 끊기 동작을 시작한다.  
이 경우 서버측에서 애플리케이션이 Socket 라이브러리의 close 를 호출하고, TCP 담당 부분이 FIN 이라는 컨트롤 비트에 1을 설정한 TCP  
헤더를 만든 후 담당 부분에 의뢰하여 클라이언트에 보낸다. 이것이 클라이언트에 도착하면 클라이언트는 ACK 번호를 반송한다. 클라이언트가 close  
를 계속 호출하고, FIN 을 1로 한 TCP 헤더를 서버에 보낸 후 서버가 ACK 번호를 반송하면 연결 끊기 동작은 끝이 난다.  
HTTP 1.1 은 클라이언트에서 먼저 연결 끊기 동작을 시작할 수도 있지만, 이 경우는 클라이언트와 서버의 순번만 반대가 된다.  
어느 경우든 연결 끊기 동작이 끝나면 잠시 기다렸다가 소켓을 말소한다.


