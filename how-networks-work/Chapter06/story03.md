# 서버 소프트웨어가 리퀘스트 메시지의 의미를 해석하여 요구에 응한다.

## 조회의 URI 를 실제 파일명으로 변환한다.

웹 서버의 경우 read 에서 받은 데이터의 내용이 HTTP 리퀘스트 메시지가 되고, 받은 리퀘스트 메시지에 기록되어 있는 내용에 따라  
적절한 처리를 실행하여 응답 메시지를 만들고, write 를 통해 이것을 클라이언트에 반송한다는 형태로 작동한다.

리퀘스트 메시지에는 메소드라는 일종의 명령과 데이터 출처를 나타내는 URI 라는 파일의 경로명 같은 것이 쓰여있으며,  
내용에 따라 데이터를 클라이언트에 반송한다. 이 경우 메소드나 URI 의 내용에 따라 웹 서버 내부의 동작이 달라진다.

가장 간단한 것은 GET 메소드와 HTML 문서의 파일명을 나타내는 URI 를 기록한 리퀘스트 이다. 이 경우 파일에서 HTML 문서의 데이터를  
읽어들이고 이것을 응답 메시지로 반송하지만, 단순히 URI 에 기록되어 있는 파일을 디스크에서 읽는 것은 아니다.  
단순히 URI 에 기록되어 있는 경로명의 파일을 읽어오면 디스크의 파일에 전부 액세스할 수 있게 되므로 웹 서버의 디스크가 무방비 상태로  
노출되어 위험하기 때문에, 웹 서버에서 공개하는 디렉토리는 실제 디렉토리가 아닌 가상으로 만든 디렉토리를 사용하고, 이 가상 디렉토리 구조에서의  
경로명을 URI 에 써야한다.

이 가상 디렉토리의 경로명을 디스크에서 읽어온 후 데이터를 반송하는 형태인데, 이러한 변환에는 특별한 예가 있다.  
URI 에 쓰여있는 경로명이 파일명을 생략한 형태인 경우에는 미리 설정한 파일명이 쓰여있는 것으로 간주하여 변환하는 것이다.  
일반적으로 `index.html, index.cgi, default.htm` 등이 있다.

## CGI 프로그램을 작동하는 경우

URI 에는 HTML 문서 뿐만 아니라 프로그램 파일의 이름을 사용할 수도 있는데, 이 경우레는 파일의 내용을 그대로 반송하지 않고 해당 프로그램을  
작동시켜서 프로그램이 출력하는 데이터를 클라이언트에 반송한다.  

그 중 CGI 라는 타입의 프로그램은 다음과 같이 동작한다.  
무언가의 데이터를 리퀘스트 메시지의 안에 넣어 브라우저에서 웹 서버로 보내고, 웹 서버는 URI 의 부분에 쓰여있는 파일명을 조사하여 이것이  
프로그램인지 판단한다. .cgi, .php 확장자를 등록해 두고 파일명의 확장자가 이것과 일치하면 프로그램으로 간주하는 것이다.  
파일이 프로그램이면 웹 서버는 이 프로그램을 작동시키도록 OS 에 의뢰한다. 그리고 리퀘스트 메시지에서 데이터를 추출하여 작동시킨  
프로그램에 건네준다. 그 후 작동시킨 프로그램이 받은 데이터를 처리하여 웹 서버에 돌려준 뒤, 웹 서버는 클라이언트에 반송한다.

## 웹 서버로 수행하는 액세스 제어

웹 서버의 기본 동작은 리퀘스트 메시지의 내용에서 데이터 출처를 판단하고, 그곳에서 데이터를 얻어 클라이언트에 반송한다는 것이다. 하지만 이 동작을  
실행할 때 사전에 설정해 둔 조건에 해당하는지 조사하고, 조건에 해당하는 경우 동작을 금지하거나 조건에 해당하는 경우만 동작을 실행한다는 기능이  
있는데, 이것을 액세스 제어라고 한다.

액세스 제어를 웹 서버에서 설정하는 조건은 주로 클라이언트의 주소, 클라이언트의 도메인명, 사용자명과 패스워드 이 세가지 이다.

클라이언트의 IP 주소가 조건으로 설정되어 있을 때는 accept 로 접속을 접수 했을 때 점검하기만 하면 된다.

클라이언트의 도메인명이 조건으로 설정되어 있는 경우에는, DNS 서버를 이용해 조사한다.

사용자명과 패스워드가 설정된 경우에는 Authorization 라는 헤더 필드를 사용해 조사하고, 액세스를 허가하는 경우 데이터를 반송한다.

## 응답 메시지를 되돌려 보낸다.

이렇게 해서 리퀘스트 메시지에 대해 적절하게 처리하고 처리가 완료되면 응답메시지를 반송한다.

먼저 웹 서버가 Socket 라이브러리의 write 를 호출하여 응답 메시지를 프로토콜 스택에 건네주는데, 이 때 응답 메시지를 어디에 보내야 할지  
프로토콜 스택에 알려주는 것은 디스크립터를 사용해 지정한다.  
그러면 프로토콜 스택은 데이터를 한 개의 패킷에 들어가는 길이로 분할하고 헤더를 붙여 패킷을 송출한다. 그러면 해당 패킷은 스위치나 라우터를  
경우하여 인터넷 속을 통해 최종적으로 클라이언트에게 도착한다.
