# IP 와 이더넷의 패킷 송/수신 동작

## 패킷의 기본

TCP 담당 부분은 접속, 송/수신, 연결 끊기의 단계에서 통신 상대와 대화 할 때 IP 담당 부분에  
의뢰하여 대화하는 데이터를 패킷의 모습으로 만들어 상대에게 도착한다.

패킷은 `헤더` 와 `데이터` 두 부분으로 구성되는데,  
헤더에는 수신처를 나타내는 주소 등의 제어 정보가 들어있고,  
데이터에는 의뢰처에서 의뢰한 데이터가 들어있다.

### 패킷의 기본형
```
| 헤더 | 데이터 (내용) |
```
패킷의 맨 앞에 제어 정보가 담긴 헤더가 있고,  
패킷으로 운반하는 데이터가 뒤에 들어간다.

### TCP/IP의 패킷
```
|-----------이더넷의 패킷------------------|
          |--------IP의 패킷-------------|
| MAC 헤더 | IP 헤더 | TCP 헤더 | 데이터 조각 |
```
MAC 헤더 : 이더넷의 제어 정보  
IP 헤더 : IP 의 제어 정보  
TCP 헤더 : TCP 의 제어 정보  
데이터 조각 : 실제 보내는 데이터의 내용  

보통 TCP 헤더와 데이터 조각이 패킷의 내용이 된다.

### 패킷의 이동 과정

패킷은 송신처가 되는 기기가 만드는데, 헤더에 적절한 제어 정보를 기록하고,  
데이터 부분에 얼마간의 데이터를 넣은 후 패킷을 가장 가까운 중계 장치에 보낸다.  
가까운 중계 장치에서는 도착한 패킷의 헤더를 조사하여 패킷의 목적지를 판단하는데,  
이 때 사용하는게 어느 수신처가 어느 방향에 있는지에 대한 정보를 기록한 표와 같은 것이다.

패킷의 헤더에 기록되어 있는 수신처와 표에 등록된 내용을 결합하여 패킷의 수신처가 어느 케이블로  
가야 도착 할 수 있는지 판단 할 수 있고, 해당 케이블로 패킷을 송신한다.  
이 방법으로 계속해서 패킷을 중계하다보면 최종적으로 수신처의 기기에 패킷이 도착하는 것이다.

패킷의 이동은 송신처에서 수신처로 이동하는데, 회답할때는 송신처와 수신처가 뒤바뀌기 때문에,  
송신처와 수신처를 명확하게 구분하지 않는 쪽이 편리하다.  
그리고 이러한 경우 송신처와 수신처의 기기를 묶어서 `엔드 노드` 라고 부른다.

TCP/IP 네트워크에서는 서브넷이라는 작은 네트워크를 만들어 사용하는데,  
서브넷은 `라우터` 와 `허브` 라는 두 종류의 패킷 중계 장치를 사용하여 각각의 역할을 분담하면서  
패킷을 운반하기 때문에 위에서 설명한 패킷의 기본보다 좀 더 복잡하다.

```
기본적으로 라우터는 목적지를 확인하여 다음 라우터를 나타내고,  
허브는 서브넷 안에서 패킷을 운반하여 다음 라우터에 도착하는 역할을 한다.
```

즉, 허브는 이더넷의 규칙에 따라 패킷을 운반하고, 라우터는 IP의 규칙에 따라 패킷을 운반하는 것이다.  

위의 내용을 바꾸어 말하면,

```
IP는 목적지를 확인하여 다음 IP의 중계 장치를 나타내고,  
서브넷 안에 있는 이더넷이 중계 장치까지 패킷을 운반하는 역할을 한다.
```

라고 할 수 있고, 좀 더 구체적으로 말하면 

```
라우터에서 설정한 MAC 헤더(이더넷용 헤더) 와  
허브에서 설정한 IP 헤더(IP용 헤더) 가 패킷에 붙어있는 것이다.
```

그래서 패킷이 이동하는 동작은 다음과 같다.

먼저 패킷의 목적지가 되는 액세스 대상 서버의 IP 주소를 IP 헤더의 수신처에 기록한다.  
IP는 이 수신처가 어느 방향에 있는지 조사하고, 해당 방향에 있는 다음 라우터를 조사 한 뒤, 해당 라우터로 패킷이 전달 될 수 있게 이더넷에 의뢰한다.  
의뢰를 할 때는 다음 라우터에 할당된 이더넷의 주소(MAC 주소)를 조사하고, MAC 헤더에 기록하여 이더넷에게 어느 라우터로 패킷을 전달 해야 되는지 알려준다.

이렇게 패킷을 송신하면 이더넷의 원리에 따라 움직이는 허브에 도착하고, 허브에서는 이더넷의 헤더의 수신처 정보와 가지고 있는 이더넷용 표를  
결합하여 패킷의 목적지를 판단한 뒤 중계한다.  
이 때 허브가 복수일 경우 허브를 순차적으로 경유하여 패킷이 진행된다.

그 후 패킷이 라우터에 도착하고, 라우터에서는 IP 용 표와 IP 헤더의 수신처를 결합하여 다음 중계를 할 라우터를 판단한 뒤,  
다음 라우터에 할당된 MAC 주소를 조사하고, MAC 헤더에 기록한 다음 이더넷에 의뢰하여 다음 라우터로 패킷을 송신한다.  
이 과정을 반복하면 패킷은 목적지에 도착하고, 도착한 패킷을 수신하면 패킷을 전달하는 동작이 완료된다.  

패킷이 이동하는 과정을 보면 패킷이 라우터에 도착한 뒤 다음 라우터로 갈 때 MAC 헤더가 바뀌고, IP 헤더는 바뀌지 않는 것을 볼 수 있다.  
IP 헤더는 실제 목적지를 나타내는 것이기 때문에 변하지 않고, MAC 헤더는 중계되는 다음 라우터를 나타내는 것이기 때문에 변경 된다.  

이 이더넷 부분은 `무선 LAN`, `ADSL`, `FTTH` 등 IP 의 의뢰를 받아 패킷을 운반 할 수 있는 것이면 무엇이든 이더넷 대신 사용 가능하다.  
이 경우 MAC 헤더가 통신 기술의 사양에 적합한 헤더로 대체된다는게 다를 뿐 동작은 똑같다.

이렇게 역할을 분담하는 이유는 이더넷과 같은 거대한 네트워크를 구축하려면 유연성이 꼭 필요하기 때문이다.

## 패킷 송/수신 동작의 개요

TCP 담당 부분이 IP 담당 부분에 패킷 송신을 의뢰 할 때, TCP 담당 부분 에서 데이터 조각에 TCP 헤더를 추가하여 IP 담당 부분에 건네준다.  
IP 담당 부분에서는 IP 헤더와 MAC 헤더를 부가하고, 네트워크용 하드웨어에 패킷을 건네준다.  
여기서 네트워크용 하드웨어란 이더넷이나 무선 LAN 등을 말한다. (형태에 따라 호칭이 다르므로 혼동을 막기위해 이후부터는 `LAN 어댑터` 라고 통칭한다.)

LAN 어댑터에 건네주는 패킷의 모습은 0이나 1의 비트가 이어진 디지털 데이터로 생각하면 되고, 해당 패킷이 LAN 어댑터에 의해  
전기나 빛의 신호 상태로 바뀌어 케이블에 송출 된다.  
이 신호는 허브나 라우터 등의 중계 장치에 도착하고, 중계 장치가 상대가 있는 곳까지 패킷을 전달한다.  
패킷이 상대에게 도착하고 난 후에는 회답이 되는데, 이 회답되는 패킷이 이동하는 것 역시 송신 동작의 반대라고 생각하면 된다.

케이블에서 신호의 모습을 한 패킷을 LAN 어댑터가 디지털 데이터의 모습으로 되돌리고, IP 담당 부분에게 건내준 뒤, MAC 헤더와  
IP 헤더를 제외한 TCP 헤더, 데이터 조각을 TCP 담당 부분에게 건내준다.  
IP 담당 부분은 TCP 담당 부분에서 건네준 데이터를 하나의 바이너리 데이터로 간주해서 처리하기 때문에, 해당 패킷이 이상이 있는지나  
TCP 의 동작 단계에 대한 신경은 쓰지 않는다.  

## 수신처 IP 주소를 기록한 IP 헤더를 만든다.

IP 담당 부분은 패킷 송/수신 의뢰를 받으면 IP 헤더를 만들어 TCP 헤더 앞에 붙인다.  
이 때, IP 헤더의 수신처 IP 주소에는 통신 상대의 주소를 설정하고,  
송신처 IP 주소는 송신처가 되는 LAN 어댑터를 판단하여 주소를 설정한다.  
프로토콜 번호라는 필드에도 IP 담당 부분이 어디에서 의뢰를 받았는지 표시해준다.

### IP 헤더의 포맷

IP 헤더는 20바이트로 이루어져 있으며,  
각 각의 필드에는 다음과 같은 정보들이 존재한다.

#### 버전

길이(비트)는 4 이며,  
IP 프로토콜의 버전을 나타낸다. 현재 사용하는 것은 버전 4이다.

#### 헤더 길이(IHL)

길이(비트)는 4 이며,  
IP 헤더의 길이를 나타낸다.  
프로토콜 옵션의 유무에 따라 헤더 길이가 달라지기 때문에 헤더 길이를 알도록 하기 위한 것이다.

#### 서비스 유형(ToS)

길이(비트)는 8 이며,  
패킷을 운반할 때의 우선 순위 등을 나타낸다.  
처음 사양이 모호했기 때문에 최근 DiffServ 라는 사양으로 이 필드의 사용법을 재정의했다.

#### 전체 길이

길이(비트)는 16 이며,  
IP 메세지의 전체 길이를 나타낸다.

#### ID 정보(Identification)

길이(비트)는 16 이며,  
각 패킷을 식별하는 번호이다.  
보통 패킷의 참조 번호가 여기에 기록된다. 단, IP 클라이언트에 따라 분할된 패킷은 모두 값이 같다.

#### 플래그

길이(비트)는 3 이며,  
해당 필드는 3비트이지만, 유효한건 2비트이다.  
이 중 하나로 조각 나누기가 가능한지 나타내고, 또 하나로 해당 패킷이 조각으로 나눈 것인지 나타낸다.

#### 프래그먼트 오프셋

길이(비트)는 13 이며,  
해당 패킷에 저장되어 있는 부분이 IP 메시지의 맨 앞부분부터 몇 번째 바이트에 위치하는지를 기록한다.

#### 생존 기간(TTL)

길이(비트)는 8 이며,  
네트워크에 루프를 만들 수 있을 때 패킷이 영구적으로 순환되지 않도록 생존 기간을 지정한 것으로,  
라우터를 경유할 때마다 이 값이 1씩 감소하여 0이 되면 패킷이 폐기된다.

#### 프로토콜 번호

길이(비트)는 8 이며,  
프로토콜의 번호가 기록된다.
- TCP : 06(16진수 표기)
- UDP : 11(16진수 표기)
- ICMP : 01(16진수 표기)

#### 헤더 체크섬

길이(비트)는 16 이며,  
오류 검사용 데이터로, 현재는 사용하지 않는다.

#### 송신처 IP 주소

길이(비트)는 32 이며,  
해당 패킷을 발신한 쪽의 IP 주소이다.

#### 수신처 IP 주소

길이(비트)는 32 이며,  
해당 패킷을 전달할 상대의 IP 주소이다.

#### 옵션

길이(비트)는 가변 길이 이며,  
위의 헤더 필드 이외의 제어 정보를 기록할 때 사용하는 필드이지만, 사용하는 일은 거의 없다.

## 이더넷용 MAC 헤더를 만든다.

IP 담당 부분은 IP 헤더를 붙이고 난 뒤, 그 앞에 MAC 헤더를 붙인다.  
MAC 헤더를 만들 때는 이더 타입(EtherType) 이라는 IP 헤더의 프로토콜 번호와 비슷한 필드의 값을 채운 뒤,  
송신처의 MAC 주소와, 수신처의 MAC 주소를 기록하여 헤더를 만든다.

MAC 주소를 입력하는 필드의 길이가 48인 이유는, 해당 길이의 주소가 하나의 값이 되기 때문이다.  

### MAC 헤더의 포맷

MAC 헤더는 14바이트로 이루어져 있으며,  
각 각의 필드에는 다음과 같은 정보들이 존재한다.

#### 수신처 MAC 주소

길이(비트)는 48 이며,  
해당 패킷을 전달하는 상대의 MAC 주소이다.  
LAN 에서의 패킷 배송은 이 주소를 바탕으로 수행된다.

#### 송신처 MAC 주소

길이(비트)는 48 이며,  
해당 패킷을 송신한 측의 MAC 주소이다.  
패킷을 받았을 때 이 값에 따라 누가 보냈는지 판단한다.

#### 이더 타입 (EtherType)

길이(비트)는 16 이며,  
사용하는 프로토콜의 종류를 나타낸다.  
가장 대표적인 것은 아래와 같지만, 보통의 TCP/IP 통신에 사용하는 것은 0800, 0806 두 개이다.

`0000-05DC`, `0800`, `0806`, `86DD`, `IEEE 802.3`, `IP 프로토콜`, `ARP 프로토콜`, `IPv6`

## ARP 로 수신처 라우터의 MAC 주소를 조사한다.

이더넷에는 연결이 되어있는 전원에게 패킷을 전달하는 `브로드캐스트`라는 구조가 있다.  
이 구조를 이용하여 상대가 자신과 같은 네트워크에 존재하면 해당 IP 주소를 사용해 보내는 상대의 MAC 주소를 알 수 있다.  
알아온 MAC 주소를 MAC 헤더에 설정하여 헤더를 만든다.

하지만 패킷을 보낼 때마다 이 동작을 반복하면 ARP 의 패킷이 불어나기 때문에, 한 번 조사한 결과는 ARP 캐시 라는 메모리 영역에  
보존했다가 다시 사용한다. 그렇기 때문에 ARP 캐시를 먼저 조사 한 후 없으면 ARP 를 조회하고, 조회된 값은 MAC 헤더에 등록하면서 캐시에 보관한다.

ARP 캐시에 저장된 MAC 주소가 언제까지 계속 유지 된다는 보장은 없기 때문에, ARP 캐시에 저장된 값은 시간이 되면 삭제하게 되어있고,  
그 시간은 OS 종류에 따라 다르지만 보통 몇 분 정도이다. 삭제 동작은 ARP 캐시의 내용이 유효한지 여부와 관계 없이 시간이 지나면 무조건  
삭제가 되기 때문에 난폭하지만, 이렇기 때문에 문제가 생기지 않는다.

## 이더넷의 기본

이더넷은 다수의 컴퓨터가 여러 상대와 자유롭게 적은 비용으로 통신하기 위해 고안된 통신 기술이다.  
이더넷의 원형은 컴퓨터가 신호를 송신하면 케이블을 통해 네트워크 전체에 신호가 흐르고, 전원에게 신호가 도착한다.  
하지만 이런 동작만으로는 도착한 신호가 누구에게 갈 것인지 판단 할 수 없으므로 신호의 맨 앞부분에 수신처 주소를 써둔다.  
그렇게 해당하는 기기는 패킷을 수신하고 다른 기기는 패킷을 폐기한다.

이 방법으로 원하는 상대에게만 패킷이 도착하게 하는데, 이 동작을 제어하기 위해 MAC 헤더를 사용한다.  
MAC 헤더에 있는 수신처 MAC 주소에 따라 패킷을 받을 기기가 지정되고, 송신처 MAC 주소에 따라 누가 송신을 했는지 알 수  
있으며, 이더 타입에 의해 패킷의 내용물로 무엇이 들어있는지 알 수 있는 것이다.

케이블을 통해 신호가 전체에 흐르는 원형에서, 트렁크 케이블이 리피터 허브로,  
트랜시버 케이블이 트위스트 페어 케이블로 바뀌어 해당 기기들을 사용하는 모습으로 변하게 된다.  
기본적인 성질은 변하지 않고, 리피터 허브로부터 신호가 흩뿌려져 전체에 전달되는 식으로 변경이 되었다.

그리고 그 후에 스위칭 허브를 사용한 형태로 변경이 되었는데, 현재 이더넷이라고 말하는 것은 이 형태를 가리킨다.  
언뜻 보면 리피터 허브를 사용하는 것과 비슷하지만, 수신처 MAC 주소에만 신호가 흐르고, 다른곳에는 신호가 흐르지 않게 된  
형태이다. 수신처 MAC 주소의 상대에게 패킷이 전달된다는 점이 변하지 않았기 때문에 MAC 헤더는 그대로 사용할 수 있는것이다.

이더넷도 IP와 마찬가지로 패킷의 내용물은 보지 않는다.

## IP 패킷을 전기나 빛의 신호로 변환하여 송신한다.

IP 패킷은 메모리에 기억된 디지털 데이터이므로 전기나 빛의 신호로 변환하여 네트워크의 케이블에 송출해야 하는데,  
이 동작을 실행하는 것이 LAN 어댑터이다.  
LAN 어댑터는 단독으로 동작하지 않으며, 이 LAN 어댑터를 제어 할 수 있는 LAN 드라이버 소프트웨어가 필요하다.

LAN 어댑터는 전원을 공급하면 즉시 사용할 수 있는게 아니라 초기화 작업이 필요한데, 이 초기화는 LAN 드라이버가 한다.  
초기화 작업에서 실행하는 작업은 하드웨어 이상 검사, 초기 설정, MAC 라는 회로에 MAC 주소 설정 등이 있다.

ROM 에는 전 세계적으로 중복되지 않도록 일원화해서 관리하는 MAC 주소를 제조할 때 기록하기 때문에 이것을 읽어와서 MAC 회로에  
설정한다. 이렇게 해서 MAC 회로는 자체에 할당된 MAC 주소가 무엇인지 알게된다.

### LAN 어댑터의 내부 구조

LAN 어댑터의 실제 제품 구조는 제조 업체나 기종에 따라 다르지만, 개념적으로 보면 다음과 같다.

#### 버퍼 메모리

송/수신하는 패킷을 일시적으로 저장하는 메모리이다.

#### MAC

충돌 검출/다시 송신 등 이더넷의 송/수신 동작을 제어하는 부분이다.

#### PHY(MAU)

신호를 송신하는 회로와 신호를 수신하는 회로를 합친 것이다.

#### RJ-45 커넥터

LAN 케이블을 접속하는 커넥터이다.

#### ROM

MAC 주소를 기입하는 부분이다.

## 패킷에 3개의 제어용 데이터를 추가한다.

LAN 드라이버가 IP 담당 부분에서 패킷을 받게 되면 해당 패킷을 LAN 어댑터의 버퍼 메모리에 복사 한 뒤, 패킷을 송신하도록  
MAC 회로에 명령을 보내고, MAC 회로가 작업을 시작한다.

MAC 회로는 먼저 송신 패킷을 버퍼 메모리에서 추출한 뒤 해당 데이터의 맨 앞에는 `프리앰블` 과 `스타트 프레임 딜리미터` 라는 두 개의 데이터를,  
맨 끝에는 `프레임 체크 시퀀스(FCS)` 라는 오류 검출용 데이터를 부가한다.

프리앰블은 송신하는 패킷을 읽을 때의 타이밍을 잡기 위한 것으로, 1과 0이 번갈아 나타나는 비트열이 56비트 이어진 것이다.  
이 비트 패턴을 신호로 바꾸면 파형이 일정한 모습을 가진 신호가 되는데, 수신측은 해당 신호를 수신할 때 이 파형에서 타이밍을 판단한다.  

디지털 데이터를 전기 신호로 나타낼 때 0과 1의 비트 값을 전압이나 전류의 값에 대응시킨다. 신호에서 데이터를 읽을 때의 동작은  
이 대응을 반대로 실행하면 된다. 신호의 전압이나 전류의 값을 읽고 거기에서 0과 1의 비트 값으로 되돌리면 된다.  

1과 0이 계속 이어지면 신호의 변화가 없어져서 비트 구분을 판단할 수 없게 된다는 문제가 있지만, 이 문제를 해결하기 위해선  
데이터를 나타내는 신호와 별도로 비트 구분을 나타내는 `클록` 이라는 신호를 보내는 방법이 있다.

데이터 신호와 클록 신호를 합성하여 한 개의 신호로 만들어 문제를 해결 할 수 있다.

이런 클록 신호의 타이밍을 잡기 위한 특별한 신호를 패킷 앞에 부가하는데, 이것이 프리앰블의 역할이다.

프리앰블에 이어지는 스타트 프레임 딜리미터는 패킷의 시작을 나타내는 표시이다.  

끝에 부가하는 FCS 는 패킷을 운반하는 도중 잡음 등의 영향으로 파형이 흐트려져 데이터가 변한 경우 이걸 검출하기 위해 사용한다.

## 허브를 향해 패킷을 송신한다.

프리앰블, 스타트 프레임 딜리미터, FCS 의 세 가지를 부가하면 케이블에 송출하는 패킷이 완성되고, 신호를 송신하는 동작을 취하는데,  
이 동작은 리피터 허브를 사용했을 때의 반이중 모드와 스위칭 허브를 사용한 전이중 모드의 두 가지가 있다.

LAN 어댑터의 MAC 회로가 공통 형식의 신호를 만들고 PHY(MAU) 회로가 케이블에 송출하는 형식으로 변환하여 케이블에 송신한다.

## 돌아온 패킷을 받는다.

신호를 받을 때는 신호의 맨 앞에 있는 프리앰블로 파형에서 타이밍을 계산하고, 스타트 프레임 딜리미터가 나오면 그 다음 비트부터  
디지털 데이터로 변환하고, 마지막 FCS 값으로 오류 검사를 한 뒤, 오류가 검출되면 폐기한다.
오류가 검출이 되지 않으면 MAC 헤더의 수신처 MAC 주소가 자신인지 판단 한 뒤 자신이 아니면 폐기한다.  
수신처 MAC 주소가 자신일 경우 패킷을 받아 버퍼 메모리에 저장한 뒤 패킷 수신한 사실을 컴퓨터 본체에 통지한다.  
통지 할 때는 `인터럽트` 라는 구조를 사용하는데, 인터럽트란 컴퓨터 본체가 실행하고 있는 작업에 끼어들어 LAN 어댑터쪽에 주의시키는  
것이다.

## 서버의 응답 패킷을 IP 에서 TCP 로 넘긴다.

서버에서 반송된 패킷의 타입은 `0800` 이므로 LAN 드라이버에서 TCP/IP 프로토콜 스택으로 패킷을 건내준다.  
그렇게 되면 IP 담당 부분은 IP 헤더 부분을 조사하여 포맷에 문제가 없는지 확인하고, 수신처 IP 주소를 조사한다.  
수신처 IP 주소가 자신의 주소와 다르면 오류가 있는 것이므로 `ICMP` 라는 메시지를 사용하여 통신 상대에게 오류를 통지한다.  
수신처 IP 주소가 올바르면 수신하는데, 이 때 IP 프로토콜에서 해당 패킷이 분할된 패킷이라면 IP 담당 부분 내부의 메모리에 저장해놓고,  
분할된 패킷이 전부 도착할때 까지 기다렸다가 패킷을 원래의 모습으로 되돌리는 `리어셈블링(reassembling)` 이라는 동작을 한다.

이렇게 IP 담당 부분에서 TCP 담당 부분으로 패킷을 건네주면, TCP 담당 부분에서는 IP 헤더에 기록된 수신처 IP 주소, 송신처 IP 주소,  
TCP 헤더에 기록된 수신처 포트 번호, 송신처 포트 번호 이 네가지 항목을 조사하여 해당하는 소켓을 찾고, 적절한 동작을 실행한다.
