# 서버에 접속한다.

## 접속의 의미

소켓을 만들고 나서 애플리케이션은 `connect` 를 호출한다.  
그러면 프로토콜 스택은 해당 소켓을 서버측 소켓에 접속하는데,  

`connect` 를 호출하는 이유는 `socket`을 호출해 소켓을 만드는 과정 만으로는  
프로토콜 스택에 어떤 서버의 IP 주소로 데이터를 수신할건지,   
어떤 포트로 접근 할건지 등의 필요한 정보가 등록되지 않기 때문이다.

`connect` 를 호출 했을 때 프로토콜 스택 내부의 동작은  
해당 소켓과 통신 할 소켓 사이에 제어 정보를 주고 받아   
소켓에 필요한 정보를 기록하여 데이터 송/수신이 가능한 상태로 만들고,  
데이터 송/수신 동작을 실행 할 때 데이터를 일시적으로 저장하는   
메모리 영역(버퍼 메모리)을 확보한다.

## 맨 앞부분에 제어 정보를 기록한 헤더를 배치한다.

제어 정보는 크게 두가지 종류로 나눠지는데,  
클라이언트와 서버가 서로 연락을 절충하기 위해 주고받는 제어 정보와  
소켓에 기록하여 프로토콜 스택의 동작을 제어하기 위한 제어 정보가 있다.

클라이언트와 서버간에 주고받는 제어 정보는 접속 동작뿐만 아니라 데이터를 송/수신하는  
동작이나 연결을 끊는 동작도 포함하여 통신 동작 전체에서 어떤 정보가 필요한지 검토하여  
내용을 TCP 프로토콜의 사양으로 규정하고 있다.

이런 제어 정보들은 패킷의 맨 앞부분에 배치하는데, 이걸 `헤더`라고 부른다.  
하지만 TCP 만 헤더를 가지고 있는게 아니라, IP, 이더넷에도 헤더가 있기 때문에,  
이 헤더가 무슨 헤더인지 알 수 있도록 써야한다.

소켓에 기록되는 제어 정보는 애플리케이션에서 통지된 정보, 통신 상대로부터 받은  
정보, 송/수신 동작의 진행 상황 등이 수시로 기록되고, 이 제어 정보는 상대측에서  
볼 수 없게 되어있다.

### TCP 헤더의 포맷

TCP 헤더는 20바이트로 이루어져 있으며,  
각 각의 필드에는 다음과 같은 정보들이 존재한다.

#### 송신처 포트 번호

길이(비트)는 16 이며,  
해당 패킷을 송신한 측 프로그램의 포트 번호이다.

#### 수신처 포트 번호

길이(비트)는 16 이며,  
해당 패킷을 받는 상대 프로그램의 포트 번호이다.

#### 시퀀스 번호 (송신 데이터의 일련 번호)

길이(비트)는 32 이며,  
해당 패킷 맨 앞의 데이터가 송신 데이터 몇번째 바이트에  
해당하는지를 송신측에서 수신측에 전달하기 위한 것이다.

#### ACK 번호 (수신 데이터의 일련 번호)

길이(비트)는 32 이며,  
ACK 는 acknowledge 의 약자 `아크`라고 읽는다.
데이터가 몇 바이트까지 수신측에 도착했는지를 송신측에 전달하기 위한 것이다.

#### 데이터 오프셋

길이(비트)는 4 이며,  
데이터 부분이 어디부터 시작하는지를 나타낸다.  
헤더의 길이를 나타낸다.

#### 사용하지 않음

길이(비트)는 6 이며,  
해당 필드는 현재 사용하지 않는다.

#### 컨트롤 비트

길이(비트)는 6 이며,  
해당 필드의 각 비트가 통신 제어상의 의미를 가진다.
- `URG`: 긴급 포인터의 필드가 유효하다는 것을 나타낸다.
- `ACK`: 수신 데이터의 일련번호 필드가 유효하다는것을 나타낸다. (보통 데이터가 수신측에 올바르게 도착한것을 의미함)
- `PSH`: flush 동작에 의해 송신된 데이터임을 나타낸다.
- `RST`: 접속을 강제로 종료하고 이상 종료시에 사용한다.
- `SYN`: 송신측과 수신측에서 일련번호를 서로 확인한다. (접속 동작을 나타냄)
- `FIN`: 연결 끊기를 나타낸다.

#### 윈도우

길이(비트)는 16 이며,  
수신측에서 송신측에 윈도우 사이즈를 통지하기 위해 사용한다.  
윈도우 사이즈란, 수신 확인을 기다리지 않고 묶어서 송신 할 수 있는 데이터 양을 말한다.

#### 체크섬

길이(비트)는 16 이며,  
오류 유무를 검사하기 위한 것이다.

#### 긴급 포인터

길이(비트)는 16 이며,  
긴급하게 처리해야 할 데이터의 위치를 나타낸다.

#### 옵션

길이(비트)는 가변길이 이며,  
위의 헤더 필드 외의 제어 정보를 기록하기 위해 사용한다.  
접속 동작을 제외하면 옵션 필드를 사용하는 예는 적다.

## 접속 동작의 실제

다음은 애플리케이션에서 `connect(<디스크립터>, <서버측의 IP 주소와 포트 번호>, ...)`를 호출 할 때  
프로토콜 스택의 내부 동작이다.

프로토콜 스택의 TCP 담당 부분은 `connect` 와 같이 넘어온 서버측 IP 주소와 포트번호를  
이용해 데이터 송/수신 동작의 개시를 나타내는 제어 정보를 기록한 헤더를 만들고,  
컨트롤 비트의 SYN 이라는 비트를 1로 만든다.  

해당 TCP 헤더를 IP 담당 부분에 건네주어 송신하도록 의뢰 하고,  
IP 담당 부분이 패킷 송신 동작을 실행하고,  
네트워크를 통해 송신한 패킷이 서버에 도착하면  

서버측의 IP 담당 부분이 이것을 받아 TCP 담당 부분에 건내준다.
서버측 TCP 담당 부분이 TCP 헤더를 조사하여 수신처 포트에 해당하는 소켓을 찾아내고,  
해당 소켓에 필요한 정보를 기록하고, 접속 동작이 진행중 상태가 된 후   
서버 TCP 담당 부분에서 응답을 돌려낸다.

응답을 돌려 낼 때도, 클라이언트 측과 마찬가지고,  
송신처와 수신처의 포트, SYN 비트 등을 설정한 TCP 헤더를 만든 뒤,  
ACK 라는 컨트롤 비트를 1로 만든다.  
해당 행동은 패킷을 받았다는 것을 알리기 위한 행동이다.

클라이언트 측에서 응답을 받으면 역시 IP 담당 부분을 거쳐 TCP 담당 부분으로  
돌아오고, TCP 헤더를 조사해 서버측 접속 동작이 성공 했는지 확인 후,  
성공 했다면 (SYN 이 1일 때) 소켓에 접속 완료를 나타내는 제어 정보를 기록한 뒤,  
서버측으로 ACK 비트를 1로 만든 뒤 반송한다.

이러한 과정이 끝나면 소켓은 데이터를 송/수신 할 수 있는 상태가 되는데, 이 때  
파이프와 같은 것으로 소켓이 연결되었다고 볼 수 있으며, 이 파이프와 같은 것을 `커넥션` 이라고 한다.

이 커넥션은 close 를 호출하여 연결을 끊을 때 까지 계속 존재한다.
