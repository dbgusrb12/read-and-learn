# 방화벽의 원리와 동작

## 패킷 필터링형이 주류이다.

방화벽의 기본이 되는 개념은 특정 서버와 해당 서버 안의 특정 애플리케이션에 액세스하는 패킷만 통과시키고,  
그 외의 패킷을 차단하는 것이다.

네트워크에는 다양한 종류의 패킷이 많이 흐르는데, 이 중에서 통과시킬 패킷과 차단할 패킷을 선별하는 것은 간단한 일이  
아니기 때문에 지금까지 다양한 방법이 고안되었고, 그 중 성능, 가격, 사용 편의성 등의 이유로 패킷 필터링형이 가장 많이 보급되었다.

## 패킷 필터링의 조건 설정 개녕

패킷의 헤더에는 통신 동작을 제어하는 제어 정보가 들어있기 때문에 이것을 조사하면 여러 가지 사항을 알 수 있다.

### 주소 변환과 패킷 필터링의 조건 설정에 이용하는 항목

다음 항목들은 패킷 필터링의 조건 설정에서 자주 사용하는 것이다.

#### MAC 헤더

- 송신처 MAC 주소

#### IP 헤더

- 송신처 IP 주소
- 수신처 IP 주소
- 프로토콜 번호

#### TCP / UDP 헤더

- 송신처 포트 번호
- 수신처 포트 번호
- TCP 컨트롤 비트
- 프래그먼트

#### 헤더가 아닌 ICMP 메시지의 내용

- ICMP 메시지의 유형

## 애플리케이션을 한정할 때 포트 번호를 사용한다.

패킷 필터링의 조건을 설정할 때는 먼저 패킷의 흐름에 착안하고, 수신처 IP 주소와 송신처 IP 주소에 따라 시정과 종점을 판단한다.

공개용 서버를 설치하는 LAN 과 사내 LAN 이 분리되어있고, 웹 서버는 공개 서버용 LAN 에 접속 되어 있는 상황으로 보면,  
인터넷에서 웹 서버를 향해 패킷이 흐르는 것을 허용하기 위해 수신처 IP 주소가 웹 서버이고, 웹 서버는 포트 번호가 80번이기 때문에  
포트 번호가 80번인 패킷만 통과시킨다. (송신처를 특정 할 수 있으면 해당 사항도 추가한다.)  
그 후 수신 확인 응답의 구조가 작용해야 되기 때문에, 송신처 IP 주소가 웹 서버이고, 포트 번호가 80번인 패킷만 통과시킨다.

## 컨트롤 비트로 접속 방향을 판단한다.

위의 상황 중 웹 서버에서 인터넷측에 액세스하는 동작을 정지 시키려면, 패킷이 흐르는 방향이 아니라 액세스 방향을 판단하여  
정지시켜야 하는데, 여기서 도움이 되는 것이 TCP 헤더에 있는 컨트롤 비트 이다.

최초의 패킷은 TCP 컨트롤 비트의 SYN 비트가 1이 되고, ACK 비트가 0이 된다.

송신처 IP 주소가 웹 서버이고, 포트번호가 80번이고, 컨트롤 비트의 SYN 비트가 1이면서, ACK 비트가 0인 패킷을 막으면  
웹 서버에서 인터넷측에 액세스 하는 동작을 막을 수 있다.

이렇게 해서 허용 할 패킷을 지정하고, 그 외에는 모두 차단하도록 조건을 설정한다.  
모두 차단하는 이유는 필요한 것만 선별하여 통과시켜 미지의 위험을 막기 위해서이고, 이것이 일반적이다.

```
수신처 IP 주소가 웹 서버, 수신처 포트 번호가 80 인 패킷 허용
송신처 IP 주소가 웹 서버, 송신처 포트 번호가 80 인 패킷 허용
송신처 IP 주소가 웹 서버, 송신처 포트 번호가 80, TCP 컨트롤 비트 SYN = 1 이고, ACK = 0 인 패킷 거부
그 외에는 모두 거부
```

## 사내 LAN 에서 공개 서버용 LAN 으로 조건을 설정한다.

위의 상황과 같은 구성의 경우 인터넷, 공개 서버용 LAN 을 왕래하는 패킷 뿐만 아니라, 사내 LAN 과 공개 서버용 LAN 을  
왕래하는 패킷의 조건도 설정해야 하는데, 이 때 조건이 서로 악영향을 끼치지 않도록 주의해야 한다.

사내 LAN 과 공개 서버용 LAN 사이를 자유로이 왕래할 수 있도록 수신처 IP 주소가 공개 서버용 LAN 과 일치하고, 송신처 IP  
주소를 조건으로 설정하지 않으면, 인터넷측에서 흘러온 패킷이 무조건 공개 서버용 LAN 에 유입 되는 사태에 빠질 수 있다.

## 밖에서 사내 LAN 으로 액세스할 수 없다.

패킷 필터링형 방화벽은 패킷을 통과시킬지 차단시킬지를 판단할 뿐만 아니라 주소 변환의 기능도 가지고 있으므로 설정이 필요하다.

즉, 인터넷과 사내 LAN 을 왕래하는 패킷은 주소 변환을 해야 하기 때문에 설정이 필요한 것인데, 구체적으로는 패킷 필터링과 마찬가지로  
패킷의 시점, 종점을 조건으로 지정한 후 주소 변환이 필요한 경우에만 변환을 하고, 나머지는 변환하지 않도록 설정한다.

프라이빗 주소와 글로벌 주소의 대응이나 포트 번호의 대응은 자동으로 할 수 있기 때문에 주소 변환을 해야 하는지만 설정한다.  
주소 변환을 이용하면 당연히 인터넷측에서 사내 LAN 에는 액세스 할 수 없게 되기 때문에, 사내 LAN 에 대한 액세스를 금지하도록  
패킷 필터링의 조건을 설정할 필요가 없다.

## 방화벽을 통과한다.

방화벽에 패킷이 도착하면 조건에 해당하는지 판단하고, 통과 시킬지 차단할지를 결정 한 뒤, 차단하는 대상은 패킷을 버리고 버린 기록을 남긴다.  
버린 패킷 중 부정 침입의 흔적을 나타내는 것이 있기 때문에, 이것을 분석하여 침입자의 수법을 밝히거나 향후 부정 침입 대책에 도움이  
될 수 있기 때문이다.

통과하는 판정을 내린 경우에는 패킷을 중계하는데, 중계 동작은 라우터의 동작과 같다.  
일단 통과시킨다고 결정되면 그 이상의 특별한 구조는 없기 때문에, '패킷 필터링' 이라는 구조는 방화벽용의 특별한 구조가 아니라  
라우터의 패킷 중계 기능 중 부가 기능이라고 생각하는 것이 좋다.  
하지만 판정 조건이 복잡해지면 라우터의 명령으로 설정하기 어렵고, 버린 기록을 남기는 것도 부담스러운 작업이기 때문에 전용 하드웨어나  
소프트웨어를 사용하는 것이다.

## 방화벽으로 막을 수 없는 공격

방화벽은 패킷 흐름의 시점과 종점을 보고 통과 여부를 결정하고 패킷의 내용을 조사하지 않기 때문에 패킷 내부의 특수한 데이터가  
있다면 대처 할 수 없다.

대처 방안은 두가지가 있는데, 문제의 원인이 웹 서버 소프트웨어의 버그에 있으므로 버그를 고치는 방법이 있고,  
패킷의 내용을 조사하여 위험한 데이터가 포함되어 있는 경우 패킷을 차단하도록 하는 장치나 소프트웨어를 방화벽과는 별도로  
준비하는 방법이 있다.