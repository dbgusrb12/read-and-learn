# 캐시 서버를 이용한 서버의 부하 분산

## 캐시 서버의 이용

여러 대의 웹 서버를 설치하는 방법이 아니라 다른 방법으로 부하 분산을 하는 방법도 있다.

데이터베이스 서버와 웹 서버 같은 역할에 따라 서버를 나누는 방법으로, 이러한 역할별 분산 처리 방법  
중의 하나가 캐시서버를 사용하는 방법이다.

캐시 서버는 프록시라는 구조를 사용하여 데이터를 캐시에 저장하는 서버이다.  
프록시는 웹 서버와 클라이언트 사이에 들어가서 웹 서버에 대한 액세스 동작을 중개하는 역할을 하는데,  
액세스 동작을 중개할 때 웹 서버에서 받은 데이터를 디스크에 저장해 두고 웹 서버를 대신하여  
데이터를 클라이언트에 반송하는 기능을 가지고 있다. 이러한 것을 캐시라고 부르고, 캐시 서버는  
이 기능을 이용한다.

캐시 서버는 웹 서버에서 받아 보존해 둔 데이터를 읽어서 클라이언트에 송신만 하므로 웹 서버보다 빨리  
데이터를 송신할 수 있다.

## 캐시 서버는 갱신일로 콘텐츠를 관리한다.

캐시 서버를 사용할 때는 부하 분산 장치와 마찬가지로 캐시 서버를 웹 서버 대신 DNS 서버에 등록한다.  
캐시 서버가 리퀘스트 메시지를 받으면 내용을 조사하고, 데이터가 자신의 캐시에 저장되었는지 조사한다.

캐시가 저장되어 있지 않은 경우 Via 라는 헤더 필드를 추가하여 웹 서버에 리퀘스트를 전송한다.  
어떤 웹 서버에 전송할지 판단하는 것은 리퀘스트 메시지의 URI 에 쓰여있는 디렉토리를 보고 판단한다.  
웹 서버에 전송하고 반송 된 데이터는 캐시에 저장하고, 저장한 일시를 기록한다.  
이렇게 클라이언트와 웹 서버 사이를 중개하는 것이 프록시 구조이고, 계속해서 캐시 서버에 데이터가 축적되고,  
사용자가 액세스한 페이지가 캐시 서버에 저장되어 있는 경우가 증가한다.

캐시가 저장되어 있는 경우 웹 서버측에서 데이터가 변경되었는지 조사하기 위한 If-Modified-Since 라는  
헤더 필드를 추가하여 웹 서버에 전송한다.  
변경이 없으면 변경 없다는 응답 메시지를 반송하고, 캐시에서 데이터를 추출하여 사용자에게 보낸다.  
변경이 있다면 캐시에 저장되어 있지 않은 경우와 동일하게 동작한다.

## 프록시의 원점은 포워드 프록시이다.

지금까지 설명한 것은 프록시라는 구조를 웹 서버측에 두고 캐시 기능을 이용하는 것이지만,  
클라이언트측에 캐시 서버를 두는 방법도 있다.

캐시 서버에서 이용하는 프록시라는 구조는 원래 클라이언트측에 두는 방법에서 시작되었고,  
이 유형이 프록시의 원형인 포워드 프록시 이다.

포워드 프록시가 처음 등장했을 때 캐시를 이용하는 것이 목적이었고, 방화벽을 실현한다는 중요한  
목적이 한 가지 더 있었다.

방화벽은 인터넷에서의 부정 침입을 막는 것이지만, 이 목적을 달성하는 현실적인 방법은 인터넷과  
사내의 패킷 왕래를 전부 정지시키는 것이다. 하지만 패킷을 전부 정지시키면 인터넷에 대한 액세스도  
정지되기 때문에 필요한 것을 통과시키는 방법을 생각하기 위해 프록시 라는 구조를 고안했다.  
프록시에서 리퀘스트 메시지를 일단 받아서 인터넷을 향해 전송하면 필요한 것을 통과 시킬수 있다는 개념인데,  
이 때 프록시의 캐시를 이용하면 더 효과적이다.

이전에 액세스한 페이지의 경우 사내 LAN 에서 프록시에 액세스 하기만 하면 데이터를 손에 넣을 수 있으므로  
저속 회선에서 인터넷에 액세스 하는 것보다 매우 빨라진다.

프록시는 리퀘스트의 내용을 조사하고 전송하므로 리퀘스트 내용에 따라 액세스가 가능한지 판단 할 수 있다.

위험한 사이트나 작업과 관계 없는 사이트에 액세스를 금지한다는 제한을 마련 할 수 있다.  
패킷 필터링형 방화벽이라면 판단 근거로 IP 주소나 포트 번호라는 정보만 사용하기 때문에 이렇게  
자세히 조건을 설정하지 못한다.

포워드 프록시를 사용할 경우에는 보통 브라우저의 설정 화면에 준비되어 있는 프록시 서버라는  
항목에 포워트 프록시의 IP 주소를 설정한다. 그렇게 되면 브라우저의 리퀘스트 메시지 송신 동작이  
달라진다.  
포워드 프록시를 설정하면 URL의 내용에 상관 없이 리퀘스트를 전부 포워드 프록시로 보낸다.  

포워드 프록시를 사용할 경우 URI 의 부분에 http://... 이라는 URL 이 그대로 쓰여있어  
URL 이 전송 대상이 된다.  
서버측에 두는 캐시 서버는 설정해 둔 웹 서버에만 전송할 수 있기 떄문에 상당히 다르다.

## 포워드 프록시를 개량한 리버스 프록시

포워드 프록시를 사용할 경우 브라우저에 대한 설정이 꼭 필요하다는 특징이 있다.  
하지만 브라우저의 설정이 번거롭고, 잘못 설정할 경우 브라우저가 제대로 작동하지 않는 장애의  
원인이 되기도 한다.

이에 때라 브라우저에 프록시를 설정하지 않아도 사용할 수 있도록 개량되었다.  
리퀘스트 메시지의 URI 에 쓰여있는 디렉토리명과 전송 대상의 웹 서버를 대응시켜서 URI 부분에  
http://... 라고 쓰여있지 않은 보통의 리퀘스트 메시지를 전송할 수 있도록 했고, 이것이 서버측에  
설치하는 캐시 서버에서 채택하고 있는 방식으로 리버스 프록시 라고 부른다.

## 트랜스페어런트 프록시

캐시 서버에서 전송 대상을 판단하는 방법, 즉 리퀘스트 메시지에서 패킷의 헤더를 조사하는 방법이  
있다. 패킷의 맨 앞에 있는 IP 헤더에는 수신처 IP 주소가 기록되어 있으므로 이것을 조사하면 액세스  
대상 웹 서버가 어디 있는지 알 수 있는데, 이 방법을 트랜스페어런트 프록시 라고 부른다.

이 방법이라면 보통의 리퀘스트 메시지를 전송할 수 있으므로 포워드 프록시처럼 브라우저에 설정할 필요가  
없고, 전송 대상을 캐시 서버에 설정할 필요도 없이 어느 웹 서버에서나 전송할 수 있다.

트랜스페어런트 프록시는 포워드 프록시와 리버스 프록시의 좋은 점만 모은 형태의 편리한 구조이지만,  
트랜스페어런트 프록시에 리퀘스트 메시지를 건내주는 방법을 주의해야 된다.  
트랜스 페어런트 프록시는 브라우저에 설정하지 않으므로 브라우저는 웹 서버에 리퀘스트 메시지를 보낸다.  
리버스 프록시와 같이 DNS 서버에 등록하는 방법이라면 이 리퀘스트 메시지가 프록시에 도착하지만,  
트랜스페어런트 프록시는 DNS 서버에 등록하는 것도 없다.  
DNS 서버에 등록하면 트랜스페어런트 프록시 자체가 액세스 대상이 되어 수신처 IP 주소로 전상 대상의  
웹 서버를 판단한다는 중요한 구조를 이용할 수 없게 된다.

이것을 해결하기 위해 브라우저에서 웹 서버로 리퀘스트 메시지가 흘러가는 길에 트랜스페어런트 프록시를  
설치한다.  
그리고 메시지가 트랜스페어런트 프록시를 통과할 때 그것을 가로챈다. 편법이라는 느낌도 있지만  
이렇게 해서 리퀘스트 메시지가 트랜스페어런트 프록시에 도착하고, 웹 서버에 전송할 수 있다.

트랜스페어런트 프록시를 사용하면 사용자가 프록시의 존재를 알아차릴 필요가 거의 없다.  
따라서 HTTP 의 메시지를 전송한다는 구조에 대한 관심이 적어지고 캐시를 이용한다는 측면에서  
비중이 높아지고 있다.
