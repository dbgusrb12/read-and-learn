# 콘텐츠 배포 서비스

## 콘텐츠 배포 서비스를 이용한 부하 분산

캐시 서버를 서버측에 두는 경우와 클라이언트측에 두는 경우는 이용 효과면에서 차이가 난다.

서버측에 두는 경우는 웹 서버의 부하를 경감하는 효과가 있지만, 인터넷에 흐르는 트래픽을 억제하는 효과는 없다.  
인터넷 안에는 혼잡한 곳이 있을 수 있어서 그곳을 통과하려면 시간이 걸린다. 하지만 클라이언트측에 캐시 서버가 있으면  
이러한 혼잡에 휘말려드는 일이 없기 때문에 패킷의 흐름이 안정된다. (큰 화상이나 영상같은 데용량 데이터를 포함하는 콘텐츠에 효과가 크다.)

클라이언트측에 두는 경우는 클라이언트측의 네트워크를 운영 관리하는 사람이 소유하므로 웹 서버 운영자가 제어 할 수 없다.

프로바이더와 계약하여 웹 서버 운영자가 제어할 수 있는 캐시 서버를 클라이언트측의 프로바이더에 두는 방법으로 양쪽에 좋은 점을 모두 취할 수 있다.

인터넷에 공개하는 서버는 인터넷의 어디에서 액세스 하는지 알수 없기 때문에 해당 방법을 전면적으로 실현하려면 프로바이더의 POP 전부에  
캐시 서버를 설치해야 하지만, 이 방법은 비현실적이기 때문에 중요한 프로바이더에 중점을 두어 캐시 서버의 수를 줄일 수 있다.

하지만 아무리 캐시 서버의 수를 줄여도 웹 서버 운영자가 스스로 프로바이더와 계약하여 캐시 서버를 설치하는 것은 비용/노력 측면에서 보통 일이 아닌데,  
이 문제를 해결하기 위해 캐시 서버를 미리 설치하고 해당 서버를 웹 서버 운영자에게 대출하는 콘텐츠 배포 서비스가 탄생했다.

해당 서비스는 중요한 프로바이더와 계약하고 그곳에 다수의 캐시 서버를 설치한 뒤 웹 서버 운영자와 계약해 웹 서버와 캐시 서버를 연대시킨다.  
캐시 서버는 다수의 웹 서버의 데이터를 캐시에 저장할 수 있기 때문에 해당 서비스가 설치한 캐시 서버를 다수의 웹 서버 운영자가 공동으로  
이용 할 수도 있다.  
이렇게 웹 서버 운영자의 한 회사 당 비용을 절감 할 수 있고, 웹 서버 운영자의 비용 부담이 줄어들고, 프로바이더와의 계약은 콘텐츠 배포 서비스  
쪽에서 한번에 인수하므로 노력면에서도 부담이 되지 않는다.

## 가장 가까운 캐시 서버의 관점

콘텐츠 배포 서비스를 사용하는 경우 인터넷 전체에 설치된 다수의 캐시 서버를 이용하는데, 이런 상황에서는 가장 가까운 캐시 서버를 찾고,  
클라이언트가 여기에 액세스하도록 중재하는 구조가 필요하다.

해당 캐시 서버로 중재하는 구조 중 최초의 방법은 DNS 서버에서 액세스를 분배하는 것과 비슷하게 웹 서버의 IP 주소를 회답할 때 가장 가까운  
캐시 서버의 IP 주소를 회답하도록 DNS 서버를 세밀하게 설정하는 방법이다.

설정하는 방법은 다음과 같다.

먼저 캐시 서버의 설치 장소에 있는 라우터에서 경로 정보를 모아둔 뒤, 해당 경로표를 사용하여 클라이언트측의 DNS 서버에 이르는 경로 정보를 조사한다.  
조사한 경로 정보를 기반으로 가장 가까운 캐시 서버의 IP를 회답한다. 이 과정을 통해 정확한 거리를 측정하지는 못하지만, 웬만큼 정확하게 거리를  
측정할 수 있다.

## 리피터용 서버로 액세스 대상을 분배한다.

가장 가까운 캐시 서버에 액세스하는 방법은 한 가지가 더 있는데, HTTP 헤더 필드 중 Location 을 이용해 리다이렉트 하는 방법이다.  
리다이렉트용 서버를 웹 서버측의 DNS 등록하고, 클라이언트가 HTTP 리퀘스트 메시지를 보내면, 리다이렉트용 서버에는 DNS 서버와 같이 라우터에서  
모은 경로 정보가 있고, 여기서 가장 가까운 캐시 서버를 찾은 뒤 Location 헤더를 붙여 돌려보내면, 클라이언트는 캐시 서버에 다시 액세스한다.

이 방법은 리다이렉트에 대한 HTTP 메시지가 많아져 오버헤드가 많지만, 이전 방법에 비해 정밀도가 높다는 장점이 있다.

## 캐시 내용의 갱신 방법에서 성능의 차이가 난다.

캐시 서버의 효율을 좌우하는 요소 중에는 캐시의 내용을 갱신하는 방법이 있다.

캐시가 저장되기 전 최초의 액세스 동작에서는 캐시가 도움이 되지 않고, 두 번째 이후의 액세스에서는 원래 데이터를 가진 웹 서버에 갱신된 내용의  
유무를 확인하는 동작이 있기 때문에 이게 혼잡하게 뒤얽히면 응답 시간이 악화된다.

이 점을 개선하려면 웹 서버에서 데이터를 갱신할 경우 해당 사항을 즉시 캐시 서버에 반영해야한다.  
그렇게 되면 캐시 서버는 상항 최신 상태를 유지 할 수 있기 때문에 원래 데이터의 갱신을 확인할 필요가 없게 되고, 최초의 액세스 동작에도  
캐시의 데이터를 이용할 수 있다. 콘텐츠 배포 서비스에 이용하는 캐시 서버도 이러한 대책이 내장되어 있다.

웹 페이지는 리퀘스트를 받았을 때 CGI 애플리케이션 등에서 동적으로 페이지를 만드는 경우도 있는데, 이 경우는 캐시 서버에 데이터를 저장해 두면  
안된다. 이럴 때는 페이지 전체를 저장하는게 아닌 애플리케이션에서 만든 매번 달라지는 부분과 달라지지 않는 부분을 구분한 뒤 달라지지 않는 부분만  
캐시에 저장해야한다.